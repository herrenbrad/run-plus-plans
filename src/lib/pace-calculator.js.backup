/**
 * RunEq Training Pace Calculator
 * Based on Jack Daniels' Running Formula and McMillan Running Calculator principles
 * Converts race times to training pace zones
 */

class PaceCalculator {
    constructor() {
        // VDOT coefficients based on Daniels' Running Formula
        // These are approximations of the official tables
        this.raceDistances = {
            '5K': 5000,
            '10K': 10000,
            'Half': 21097.5,
            'Marathon': 42195
        };
    }

    /**
     * Convert race time string (MM:SS or H:MM:SS) to total seconds
     */
    timeToSeconds(timeString) {
        const parts = timeString.split(':').map(Number);
        if (parts.length === 2) {
            // MM:SS format
            return parts[0] * 60 + parts[1];
        } else if (parts.length === 3) {
            // H:MM:SS format
            return parts[0] * 3600 + parts[1] * 60 + parts[2];
        }
        throw new Error('Invalid time format. Use MM:SS or H:MM:SS');
    }

    /**
     * Convert seconds to pace string (MM:SS per mile)
     */
    secondsToPace(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }

    /**
     * Calculate training paces directly from race pace using established relationships
     * This avoids the complexity of VDOT calculations while maintaining accuracy
     */
    calculateTrainingPaces(raceDistance, raceTimeSeconds) {
        // Convert race pace to seconds per mile
        const racePacePerMile = this.getRacePacePerMile(raceDistance, raceTimeSeconds);
        
        // Calculate training paces using established relationships to race pace
        const easyPace = this.calculateEasyPace(racePacePerMile, raceDistance);
        const marathonPace = this.calculateMarathonPace(racePacePerMile, raceDistance);
        const thresholdPace = this.calculateThresholdPace(racePacePerMile, raceDistance);
        const intervalPace = this.calculateIntervalPace(racePacePerMile, raceDistance);
        const repetitionPace = this.calculateRepetitionPace(racePacePerMile, raceDistance);

        return {
            easy: {
                pace: this.secondsToPace(easyPace),
                description: 'Easy/Recovery runs',
                heartRate: '65-79% max HR'
            },
            marathon: {
                pace: this.secondsToPace(marathonPace),
                description: 'Marathon race pace',
                heartRate: '80-85% max HR'
            },
            threshold: {
                pace: this.secondsToPace(thresholdPace),
                description: 'Tempo/Threshold runs',
                heartRate: '86-90% max HR'
            },
            interval: {
                pace: this.secondsToPace(intervalPace),
                description: 'VO2 Max intervals (3-8 min)',
                heartRate: '95-100% max HR'
            },
            repetition: {
                pace: this.secondsToPace(repetitionPace),
                description: 'Short speed reps (&lt;90 sec)',
                heartRate: '105%+ max HR'
            }
        };
    }

    getRacePacePerMile(raceDistance, raceTimeSeconds) {
        const distanceInMiles = raceDistance / 1609.344;
        return raceTimeSeconds / distanceInMiles;
    }

    // Training pace calculations based on race distance and pace
    calculateEasyPace(racePacePerMile, raceDistance) {
        // Easy pace is typically 65-75% of race pace
        // Longer races = smaller adjustment needed
        let adjustment;
        switch (raceDistance) {
            case 5000:    // 5K
                adjustment = 90;  // Add 90 seconds (1:30) per mile
                break;
            case 10000:   // 10K  
                adjustment = 75;  // Add 75 seconds (1:15) per mile
                break;
            case 21097.5: // Half Marathon
                adjustment = 45;  // Add 45 seconds per mile
                break;
            case 42195:   // Marathon
                adjustment = 30;  // Add 30 seconds per mile
                break;
            default:
                adjustment = 75;
        }
        return racePacePerMile + adjustment;
    }

    calculateMarathonPace(racePacePerMile, raceDistance) {
        // Marathon pace relative to other race paces
        switch (raceDistance) {
            case 5000:    // 5K race
                return racePacePerMile + 60;  // Add 60 seconds per mile
            case 10000:   // 10K race
                return racePacePerMile + 45;  // Add 45 seconds per mile  
            case 21097.5: // Half Marathon race
                return racePacePerMile + 15;  // Add 15 seconds per mile
            case 42195:   // Marathon race
                return racePacePerMile;       // This IS marathon pace
            default:
                return racePacePerMile + 50;
        }
    }

    calculateThresholdPace(racePacePerMile, raceDistance) {
        // Threshold pace (tempo) relative to race paces
        switch (raceDistance) {
            case 5000:    // 5K race  
                return racePacePerMile + 30;  // Add 30 seconds per mile
            case 10000:   // 10K race
                return racePacePerMile + 15;  // Add 15 seconds per mile
            case 21097.5: // Half Marathon race  
                return racePacePerMile - 10;  // Subtract 10 seconds per mile
            case 42195:   // Marathon race
                return racePacePerMile - 20;  // Subtract 20 seconds per mile
            default:
                return racePacePerMile + 20;
        }
    }

    calculateIntervalPace(racePacePerMile, raceDistance) {
        // VO2 max / Interval pace
        switch (raceDistance) {
            case 5000:    // 5K race
                return racePacePerMile - 10;  // Subtract 10 seconds per mile
            case 10000:   // 10K race  
                return racePacePerMile - 20;  // Subtract 20 seconds per mile
            case 21097.5: // Half Marathon race
                return racePacePerMile - 45;  // Subtract 45 seconds per mile  
            case 42195:   // Marathon race
                return racePacePerMile - 60;  // Subtract 60 seconds per mile
            default:
                return racePacePerMile - 25;
        }
    }

    calculateRepetitionPace(racePacePerMile, raceDistance) {
        // Repetition / Speed pace (faster than 5K pace)
        switch (raceDistance) {
            case 5000:    // 5K race
                return racePacePerMile - 25;  // Subtract 25 seconds per mile
            case 10000:   // 10K race
                return racePacePerMile - 35;  // Subtract 35 seconds per mile  
            case 21097.5: // Half Marathon race
                return racePacePerMile - 60;  // Subtract 60 seconds per mile
            case 42195:   // Marathon race  
                return racePacePerMile - 75;  // Subtract 75 seconds per mile
            default:
                return racePacePerMile - 40;
        }
    }

    /**
     * Main function to calculate all training paces from a recent race
     */
    calculateFromRace(raceDistance, raceTime) {
        try {
            const distance = this.raceDistances[raceDistance];
            if (!distance) {
                throw new Error(`Unsupported race distance: ${raceDistance}`);
            }

            const timeSeconds = this.timeToSeconds(raceTime);
            const paces = this.calculateTrainingPaces(distance, timeSeconds);

            return {
                raceDistance,
                raceTime,
                racePace: this.secondsToPace(this.getRacePacePerMile(distance, timeSeconds)),
                paces
            };
        } catch (error) {
            throw new Error(`Pace calculation failed: ${error.message}`);
        }
    }

    /**
     * Calculate RunEq equivalent paces for stand-up bike workouts
     * Using the conversion factors from the Garmin data field
     */
    calculateRunEqPaces(paces, trainingEffortLevel = 'moderate') {
        const conversionFactors = {
            easy: 2.0,      // TE < 2.5
            moderate: 2.5,  // TE 2.5-3.5  
            hard: 3.0       // TE > 3.5
        };

        const runEqPaces = {};
        
        for (const [zone, paceInfo] of Object.entries(paces)) {
            // Determine appropriate conversion factor for each zone
            let factor;
            switch (zone) {
                case 'easy':
                    factor = conversionFactors.easy;
                    break;
                case 'marathon':
                case 'threshold':
                    factor = conversionFactors.moderate;
                    break;
                case 'interval':
                case 'repetition':
                    factor = conversionFactors.hard;
                    break;
                default:
                    factor = conversionFactors.moderate;
            }

            runEqPaces[zone] = {
                ...paceInfo,
                runEqFactor: factor,
                standUpBikeNote: `Stand-up bike: ${factor}x distance for equivalent training effect`
            };
        }

        return runEqPaces;
    }
}

// Export for ES modules and CommonJS
export { PaceCalculator };

// Fallback for CommonJS
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { PaceCalculator };
}

// Test the calculator with some known values
const calculator = new PaceCalculator();

// Test with a 20:00 5K (decent recreational runner)
console.log('=== Test: 20:00 5K ===');
const result1 = calculator.calculateFromRace('5K', '20:00');
console.log(JSON.stringify(result1, null, 2));

// Test with RunEq conversion
console.log('\n=== RunEq Pace Conversion ===');
const runEqResult = calculator.calculateRunEqPaces(result1.paces);
console.log(JSON.stringify(runEqResult, null, 2));